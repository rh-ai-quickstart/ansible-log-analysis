# Default values for backend.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# This will set the replicaset count more information can be found here: https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/
replicaCount: 0

# This sets the container image more information can be found here: https://kubernetes.io/docs/concepts/containers/images/
image:
  repository: quay.io/rh-ai-quickstart/alm-backend
  # This sets the pull policy for images.
  pullPolicy: Always
  # Overrides the image tag whose default is the chart appVersion.
  # Use 'rag-v1' for RAG-enabled version, or 'latest' for most recent
  tag: "latest"

# This is for the secrets for pulling an image from a private repository more information can be found here: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/
# imagePullSecrets: []
# This is to override the chart name.
nameOverride: ""
fullnameOverride: ""

# This section builds out the service account more information can be found here: https://kubernetes.io/docs/concepts/security/service-accounts/
serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Automatically mount a ServiceAccount's API credentials?
  automount: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

# This is for setting Kubernetes Annotations to a Pod.
# For more information checkout: https://kubernetes.io/docs/concepts/overview/working-with-objects/annotations/
podAnnotations: {}
# This is for setting Kubernetes Labels to a Pod.
# For more information checkout: https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/
podLabels: {}

podSecurityContext: {}
  # fsGroup: 2000

securityContext: {}
  # capabilities:
  #   drop:
  #   - ALL
  # readOnlyRootFilesystem: true
  # runAsNonRoot: true
  # runAsUser: 1000

# This is for setting up a service more information can be found here: https://kubernetes.io/docs/concepts/services-networking/service/
service:
  # This sets the service type more information can be found here: https://kubernetes.io/docs/concepts/services-networking/service/#publishing-services-service-types
  type: ClusterIP
  # This sets the ports more information can be found here: https://kubernetes.io/docs/concepts/services-networking/service/#field-spec-ports
  port: 8000
  targetPort: 8000

# This block is for setting up the ingress for more information can be found here: https://kubernetes.io/docs/concepts/services-networking/ingress/
# Ingress is disabled - using OpenShift Route for external access instead
ingress:
  enabled: false

# This block is for setting up OpenShift routes for more information can be found here: https://docs.openshift.com/container-platform/4.11/networking/routes/route-configuration.html
# Route is disabled - backend is internal-only (accessible via ClusterIP service)
route:
  enabled: false
  # Set the hostname for your OpenShift cluster
  # Example: alm-backend-<namespace>.apps.<cluster-domain>
  # If left empty, OpenShift will auto-generate a hostname
  host: ""
  path: ""
  annotations: {}
  tls:
    # Edge termination: OpenShift terminates TLS using the certificate
    termination: edge
    # Redirect HTTP to HTTPS
    insecureEdgeTerminationPolicy: Redirect
    # Optional: specify certificate and key if using passthrough or re-encrypt
    # certificate: ""
    # key: ""
    # caCertificate: ""

resources:
  limits:
    cpu: 2000m
    memory: 8Gi
    ephemeral-storage: 4Gi  # For HuggingFace model downloads during init
  requests:
    cpu: 500m
    memory: 1Gi
    ephemeral-storage: 2Gi

initResources:
  limits:
    cpu: 2000m
    memory: 8Gi
    ephemeral-storage: 4Gi  # For HuggingFace model downloads during init
  requests:
    cpu: 500m
    memory: 1Gi
    ephemeral-storage: 2Gi

# This is to setup the liveness and readiness probes more information can be found here: https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/
livenessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
readinessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 5
  periodSeconds: 5

# This section is for setting up autoscaling more information can be found here: https://kubernetes.io/docs/concepts/workloads/autoscaling/
autoscaling:
  enabled: false
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# Additional volumes on the output Deployment definition.
volumes: []
# - name: foo
#   secret:
#     secretName: mysecret
#     optional: false

# Additional volumeMounts on the output Deployment definition.
volumeMounts: []
# - name: foo
#   mountPath: "/etc/foo"
#   readOnly: true

nodeSelector: {}

tolerations: []

affinity: {}

backend:
  env:

# Environment variables for the FastAPI application
env:
  - name: DATABASE_URL
    valueFrom:
      secretKeyRef:
        name: pgvector
        key: uri
  - name: MINIO_ENDPOINT
    valueFrom:
      secretKeyRef:
        name: minio
        key: host
  - name: MINIO_ACCESS_KEY
    valueFrom:
      secretKeyRef:
        name: minio
        key: user
  - name: MINIO_SECRET_KEY
    valueFrom:
      secretKeyRef:
        name: minio
        key: password
  - name: MINIO_PORT
    valueFrom:
      secretKeyRef:
        name: minio
        key: port
  - name: LOKI_URL
    value: "http://loki:3100"

  - name: MINIO_BUCKET_NAME
    value: "clustering-model"

  - name: CLUSTERING_HOST
    value: "alm-clustering"
  - name: CLUSTERING_PORT
    value: "8001"
  - name: COLLECTOR_ENDPOINT
    value: "http://alm-phoenix:6006/v1/traces"
  - name: LOKI_MCP_SERVER_URL
    value: "http://mcp-loki:8080/stream"
  # - name: PROD_CORS_ORIGIN # TODO check me
  #   value: "http://localhost:3000"


# ConfigMap configuration
config:
  # Application configuration
  logLevel: "INFO"
  debug: false

  # LangSmith configuration
  langsmith:
    tracing: false
    apiKey: "your-langsmith-api-key"
    project: "ansible-log-monitor"
  
  # Clustering configuration
  clustering:
    sentenceTransformerModelName: "Qwen/Qwen3-Embedding-0.6B"
    algorithm: "meanshift"
    tmpClusterModelPath: "clustering_model.joblib"

# RBAC configuration
rbac:
  # Specifies whether RBAC resources should be created
  create: true
  # Rules to be added to the Role
  rules: []
  # Example rules:
  # - apiGroups: [""]
  #   resources: ["pods", "services"]
  #   verbs: ["get", "list", "watch"]

# Secrets for sensitive configuration
# secrets: {}
  # DATABASE_PASSWORD: "supersecretpassword"
  # API_KEY: "your-api-key"
  # JWT_SECRET: "jwt-signing-secret"

# PostgreSQL dependency configuration
postgresql:
  # Whether to wait for PostgreSQL to be ready before starting the main container
  waitForReady: true

# RAG (Retrieval Augmented Generation) configuration
rag:
  # Enable or disable RAG functionality
  enabled: true
  
  # RAG Service URL (microservice endpoint)
  # Backend pods communicate with RAG service via HTTP
  serviceUrl: "http://alm-rag:8002"
  
  # RAG Init Job Image (lighter image for building RAG index)
  initImage:
    repository: quay.io/rh-ai-quickstart/alm-rag
    tag: "init"
  
  # MinIO configuration (for RAG index storage)
  minio:
    endpoint: "minio"
    port: "9000"
    accessKey: "minioadmin"
    secretKey: "minioadmin"
  bucketName: "rag-index"
  forceRebuild: false  # Set to true to force rebuild even if index exists
  
  # Embedding model configuration (used by init job for building index)
  # NOTE: API credentials (apiKey, apiUrl, modelName) are provided during 'make install'
  # and stored in the 'model-secret' Kubernetes secret
  embedding:
    # Model is hardcoded to nomic-ai/nomic-embed-text-v1.5 (no config needed)
    # Service URL defaults to http://alm-embedding:8080 (local cluster service)
    apiUrl: "http://alm-embedding:8080"  # TEI service URL (defaults to local cluster service)
    port: 8080  # Port for the embedding service (TEI)
  
  # Data paths (used by init job for knowledge base PDFs)
  # Note: PDFs should be baked into the container image at /app/data/knowledge_base
  # The init job will read PDFs from the image and process them
  # The RAG index (embeddings) is stored in MinIO
  dataDir: "/app/data/rag"
  knowledgeBaseDir: "/app/data/knowledge_base"  # PDFs should be in container image
  
  # Query configuration
  query:
    # Number of top candidates to retrieve from FAISS
    topK: 4
    # Number of final results to return to the agent
    topN: 1
    # Minimum similarity threshold (0-1)
    similarityThreshold: 0.6
  
  # Resources for RAG init job
  initResources: {}
    # limits:
    #   cpu: "2"
    #   memory: "4Gi"
    # requests:
    #   cpu: "1"
    #   memory: "2Gi"
