name: Build and push image

on:
  pull_request_target:
    types: [closed]
    branches:
      - main

jobs:
  detect-changes:
    name: Detect changed directories
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    outputs:
      ui: ${{ steps.filter.outputs.ui }}
      annotation: ${{ steps.filter.outputs.annotation }}
      clustering: ${{ steps.filter.outputs.clustering }}
    steps:
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            ui:
              - 'services/ui/**'
            annotation:
              - 'services/annotation_interface/**'
            clustering:
              - 'services/clustering/**'

  build-image:
    name: Build and Push container image
    runs-on: ubuntu-latest
    needs: detect-changes
    if: github.event.pull_request.merged == true
    strategy:
      matrix:
        include:
          - name: alm-ui
            context: services/ui
            image-name: alm-ui
          - name: alm-annotation-interface
            context: services/annotation_interface
            image-name: alm-annotation-interface
          - name: alm-clustering
            context: services/clustering
            image-name: alm-clustering

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Quay.io
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      - name: Set version from run number
        id: version
        run: |
          echo "tag=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and push ${{ matrix.name }}
        if: |
          (matrix.image-name == 'alm-ui' && needs.detect-changes.outputs.ui == 'true') ||
          (matrix.image-name == 'alm-annotation-interface' && needs.detect-changes.outputs.annotation == 'true') ||
          (matrix.image-name == 'alm-clustering' && needs.detect-changes.outputs.clustering == 'true')
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.context }}/Containerfile
          push: true
          tags: |
            quay.io/rh-ai-quickstart/${{ matrix.image-name }}:${{ steps.version.outputs.tag }}
            quay.io/rh-ai-quickstart/${{ matrix.image-name }}:latest
          build-args: |
            IMAGE_TAG=${{ steps.version.outputs.tag }}

  tag-backend-latest:
    name: Tag backend image as latest
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - name: Extract source branch
        id: extract-branch
        run: |
          # Get branch name directly from GitHub event
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"

          # Sanitize branch name (replace / with -)
          BRANCH_TAG=$(echo "$BRANCH_NAME" | sed 's/\//-/g')

          echo "Source branch: $BRANCH_NAME"
          echo "Image tag: $BRANCH_TAG"
          echo "branch_tag=$BRANCH_TAG" >> $GITHUB_OUTPUT

      - name: Install skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Tag backend image as latest
        env:
          QUAY_USERNAME: ${{ secrets.QUAY_USERNAME }}
          QUAY_PASSWORD: ${{ secrets.QUAY_PASSWORD }}
          BRANCH_TAG: ${{ steps.extract-branch.outputs.branch_tag }}
        run: |
          echo "Tagging backend image from branch: $BRANCH_TAG"

          # Check if source image exists
          if skopeo inspect --creds="$QUAY_USERNAME:$QUAY_PASSWORD" \
             docker://quay.io/rh-ai-quickstart/alm-backend:$BRANCH_TAG > /dev/null 2>&1; then

            echo "Source image found: quay.io/rh-ai-quickstart/alm-backend:$BRANCH_TAG"

            # Copy/tag the image as latest
            skopeo copy \
              --src-creds="$QUAY_USERNAME:$QUAY_PASSWORD" \
              --dest-creds="$QUAY_USERNAME:$QUAY_PASSWORD" \
              docker://quay.io/rh-ai-quickstart/alm-backend:$BRANCH_TAG \
              docker://quay.io/rh-ai-quickstart/alm-backend:latest

            echo "✓ Successfully tagged alm-backend:$BRANCH_TAG as alm-backend:latest"
          else
            echo "❌ ERROR: Source image not found: quay.io/rh-ai-quickstart/alm-backend:$BRANCH_TAG"
            echo "This might happen if the developer hasn't pushed the backend image for this branch yet."
            echo "Please update the image alm-backend:latest manually from the latest version of main."
            exit 1
          fi
